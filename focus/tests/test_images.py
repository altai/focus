# -*- coding: utf-8 -*-

# Focus
# Copyright (C) 2010-2012 Grid Dynamics Consulting Services, Inc
# All Rights Reserved
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU Lesser General Public
# License as published by the Free Software Foundation; either
# version 2.1 of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public
# License along with this program. If not, see
# <http://www.gnu.org/licenses/>.


import mock
import unittest

from focus.views.blueprints import images


class ImagesTestCase(unittest.TestCase):
    def test_get_images_list(self):
        images_list = [mock.Mock(**x) for x in IMAGES_FIXTURE_ALL]
        with \
                mock.patch('flask.current_app') as current_app,\
                mock.patch('flask.g') as g,\
                mock.patch('focus.clients.user_clients')\
                as user_clients,\
                mock.patch('focus.clients.admin_clients') as clients:
            current_app.config = {
                'KEYSTONE_CONF': {
                    'admin_tenant_id': '1',
                }}
            g.tenant_id = None
            clients().glance.images.list.return_value = images_list
            result = images.get_images_list()
            self.assertEqual(len(result), 3)
            g.tenant_id = '6'
            user_clients.return_value.glance.images.list.return_value = \
                images_list
            result = images.get_images_list()
            self.assertEqual(len(result), 33)
            global_images = filter(
                lambda x: x.owner == '1',
                result)
            self.assertEqual(len(global_images), 3)
            g.tenant_id = '13'
            user_clients.return_value.glance.images.list.return_value = \
                images_list
            result = images.get_images_list()
            self.assertEqual(len(result), 15)

IMAGES_FIXTURE_ALL = [
    {'id': '10',
     'is_public': False,
     'name': None,
     'owner': None,
     'protected': False},
    {'id': '100',
     'is_public': False,
     'name': 'gitlab',
     'owner': '6',
     'protected': False},
    {'id': '102',
     'is_public': False,
     'name': 'ubuntu-12.04-beta2-server-cloudimg-amd64',
     'owner': '6',
     'protected': False},
    {'id': '103',
     'is_public': False,
     'name': 'ubuntu-12.04-beta2-server-cloudimg-amd64',
     'owner': '6',
     'protected': False},
    {'id': '104',
     'is_public': False,
     'name': 'ubuntu-12.04-25apr-server-cloudimg-amd64',
     'owner': '6',
     'protected': False},
    {'id': '1077259d-f886-46cb-afdb-d6505d0def6b',
     'is_public': False,
     'name': 'gs-atg2-snapshot-test',
     'owner': '13',
     'protected': False},
    {'id': '108',
     'is_public': False,
     'name': 'ubuntu-12.04-server',
     'owner': '6',
     'protected': False},
    {'id': '10dabafa-cce0-410c-b60a-ebd919bf831d',
     'is_public': False,
     'name': 'test-img-5afa651e-e181-415b-8a2b-24e277174d12',
     'owner': '6',
     'protected': False},
    {'id': '11',
     'is_public': False,
     'name': None,
     'owner': None,
     'protected': False},
    {'id': '112',
     'is_public': False,
     'name': 'pmo-jenkins-rc',
     'owner': '11',
     'protected': False},
    {'id': '113',
     'is_public': False,
     'name': 'chef-server-ubuntu-1',
     'owner': '4',
     'protected': False},
    {'id': '114',
     'is_public': False,
     'name': 'pmo-prepared-centos',
     'owner': '11',
     'protected': False},
    {'id': '115',
     'is_public': False,
     'name': 'pmo-updated-centos',
     'owner': '11',
     'protected': False},
    {'id': '116',
     'is_public': False,
     'name': 'pmo-prepared-centos',
     'owner': '11',
     'protected': False},
    {'id': '117',
     'is_public': False,
     'name': 'pmo-centos',
     'owner': '11',
     'protected': False},
    {'id': '12',
     'is_public': True,
     'name': 'centos6-64',
     'owner': '1',
     'protected': True},
    {'id': '120',
     'is_public': False,
     'name': 'VM Manager 3',
     'owner': '11',
     'protected': False},
    {'id': '122',
     'is_public': False,
     'name': 'pmo-oracle-temp',
     'owner': '11',
     'protected': False},
    {'id': '123',
     'is_public': False,
     'name': 'oracle v3',
     'owner': '11',
     'protected': False},
    {'id': '124',
     'is_public': False,
     'name': 'pmo-wiki',
     'owner': '11',
     'protected': False},
    {'id': '125',
     'is_public': False,
     'name': None,
     'owner': '13',
     'protected': False},
    {'id': '127',
     'is_public': False,
     'name': 'atg-with-jboss',
     'owner': '13',
     'protected': False},
    {'id': '130',
     'is_public': True,
     'name': 'ubuntu-precise-server-x64-kernel',
     'owner': '13',
     'protected': False},
    {'id': '130221f0-76d7-4035-b32d-788668c88c08',
     'is_public': False,
     'name': 'atg-prod',
     'owner': '13',
     'protected': False},
    {'id': '131',
     'is_public': True,
     'name': 'ubuntu-precise-server-x64',
     'owner': '13',
     'protected': False},
    {'id': '133',
     'is_public': True,
     'name': 'ubuntu-lucid-kernel',
     'owner': '13',
     'protected': False},
    {'id': '134',
     'is_public': True,
     'name': 'ubuntu-lucid',
     'owner': '13',
     'protected': False},
    {'id': '137',
     'is_public': False,
     'name': 'ubuntu-precise-with-atg',
     'owner': '13',
     'protected': False},
    {'id': '148',
     'is_public': False,
     'name': 'up-test-3-snapshot',
     'owner': '6',
     'protected': False},
    {'id': '150',
     'is_public': False,
     'name': 'update-test-snapshot',
     'owner': '6',
     'protected': False},
    {'id': '154',
     'is_public': False,
     'name': 'ic-staging-snapshot-2',
     'owner': '6',
     'protected': False},
    {'id': '155',
     'is_public': False,
     'name': 'up-test-1-sn1',
     'owner': '6',
     'protected': False},
    {'id': '156',
     'is_public': False,
     'name': 'up-test-1-sn2',
     'owner': '6',
     'protected': False},
    {'id': '157',
     'is_public': False,
     'name': 'up-test-1-sn3',
     'owner': '6',
     'protected': False},
    {'id': '161',
     'is_public': False,
     'name': 'centos-store',
     'owner': '13',
     'protected': False},
    {'id': '192',
     'is_public': False,
     'name': 'win2k8',
     'owner': '15',
     'protected': False},
    {'id': '196',
     'is_public': False,
     'name': 'gs-atg-img2',
     'owner': '13',
     'protected': False},
    {'id': '197',
     'is_public': False,
     'name': 'cooked_ubuntu_devstack',
     'owner': '6',
     'protected': False},
    {'id': '25',
     'is_public': False,
     'name': 'NewYearImage',
     'owner': None,
     'protected': False},
    {'id': '2b07d2fc-b14b-414a-92dc-a80cbaaa8250',
     'is_public': False,
     'name': 'test_img',
     'owner': '1',
     'protected': False},
    {'id': '30',
     'is_public': True,
     'name': 'centos56-64',
     'owner': None,
     'protected': False},
    {'id': '31',
     'is_public': False,
     'name': None,
     'owner': None,
     'protected': False},
    {'id': '32',
     'is_public': False,
     'name': None,
     'owner': None,
     'protected': False},
    {'id': '33',
     'is_public': True,
     'name': 'centos56-64',
     'owner': None,
     'protected': False},
    {'id': '34',
     'is_public': False,
     'name': 'CentOS5enStratusImage',
     'owner': None,
     'protected': False},
    {'id': '43',
     'is_public': True,
     'name': 'Mini_image',
     'owner': '1',
     'protected': True},
    {'id': '44',
     'is_public': True,
     'name': 'ubuntu-11-04_32_kernel',
     'owner': '2',
     'protected': False},
    {'id': '45',
     'is_public': True,
     'name': 'ubuntu-11-04_32',
     'owner': '2',
     'protected': False},
    {'id': '47',
     'is_public': True,
     'name': 'ubuntu-lucid',
     'owner': '8',
     'protected': False},
    {'id': '48',
     'is_public': False,
     'name': 'ubuntu-lucid-kernel',
     'owner': '8',
     'protected': False},
    {'id': '49',
     'is_public': False,
     'name': 'ubuntu-lucid',
     'owner': '8',
     'protected': False},
    {'id': '4accfef4-dd4b-4f3b-9a7b-b2fac3e77789',
     'is_public': False,
     'name': 'stest-snapshot',
     'owner': '6',
     'protected': False},
    {'id': '5493987c-d6e5-4746-8a33-86428ad43733',
     'is_public': False,
     'name': 'test-img-916a8e09-723c-45ed-a22b-607f06df65c0',
     'owner': '6',
     'protected': False},
    {'id': '58',
     'is_public': False,
     'name': 'cloud-foundry-vm-snapshot',
     'owner': '8',
     'protected': False},
    {'id': '59',
     'is_public': False,
     'name': 'ubuntu-oneiric-kernel',
     'owner': '8',
     'protected': False},
    {'id': '60',
     'is_public': False,
     'name': 'ubuntu-oneiric',
     'owner': '8',
     'protected': False},
    {'id': '638282b3-896b-4fae-8e73-8c94c8ae4ff6',
     'is_public': False,
     'name': 'test-img-1f16d1ee-5aa0-4216-97f1-a141cc8be549',
     'owner': '6',
     'protected': False},
    {'id': '64',
     'is_public': False,
     'name': 'jenkins-master',
     'owner': '8',
     'protected': False},
    {'id': '65',
     'is_public': False,
     'name': 'splastinkin-test',
     'owner': '4',
     'protected': False},
    {'id': '66',
     'is_public': False,
     'name': 'jenkins',
     'owner': '8',
     'protected': False},
    {'id': '69',
     'is_public': False,
     'name': 'pmo-wiki-rc',
     'owner': '11',
     'protected': False},
    {'id': '7',
     'is_public': False,
     'name': None,
     'owner': None,
     'protected': False},
    {'id': '78',
     'is_public': False,
     'name': 'pmo-jenkins-rc',
     'owner': '11',
     'protected': False},
    {'id': '7cef1668-b7c4-4090-be5a-e843f5dee83c',
     'is_public': False,
     'name': 'snap-focus-essex-0',
     'owner': '6',
     'protected': False},
    {'id': '7f06e538-3de6-48a7-a9f6-e408ae8e9f1f',
     'is_public': False,
     'name': 'test-img-7374fa80-af4a-4f31-9225-26b26d1d6920',
     'owner': '6',
     'protected': False},
    {'id': '8',
     'is_public': False,
     'name': None,
     'owner': None,
     'protected': False},
    {'id': '80',
     'is_public': False,
     'name': 'cf-sb-ker',
     'owner': '8',
     'protected': False},
    {'id': '82',
     'is_public': False,
     'name': 'cf-sb-img',
     'owner': '8',
     'protected': False},
    {'id': '83',
     'is_public': False,
     'name': 'cf-install_snapshot',
     'owner': '8',
     'protected': False},
    {'id': '85',
     'is_public': False,
     'name': 'up-test-1-snapshot-2',
     'owner': '6',
     'protected': False},
    {'id': '89',
     'is_public': True,
     'name': 'debian-6.0.2.1-amd64-minimal-gitlab',
     'owner': '6',
     'protected': False},
    {'id': '8cb0d0e6-b737-442c-adb3-8e82c6acef5a',
     'is_public': False,
     'name': 'centos5.7_x86_64',
     'owner': '16',
     'protected': False},
    {'id': '9',
     'is_public': True,
     'name': 'centos6-32',
     'owner': '1',
     'protected': True},
    {'id': '92',
     'is_public': False,
     'name': 'genesis-demo-image-5',
     'owner': '4',
     'protected': False},
    {'id': '93',
     'is_public': False,
     'name': 'Mini_test_public',
     'owner': '6',
     'protected': False},
    {'id': '94',
     'is_public': True,
     'name': 'ubuntu-oneiricserver-cloudimg-amd64',
     'owner': '6',
     'protected': False},
    {'id': '96',
     'is_public': False,
     'name': 'genesis-demo-image-6',
     'owner': '4',
     'protected': False},
    {'id': '97',
     'is_public': False,
     'name': 'genesis-demo-image-7',
     'owner': '4',
     'protected': False},
    {'id': 'a5b05d2e-2116-4fec-8ecb-88a691ef5f29',
     'is_public': False,
     'name': 'test-img-968a2e4f-343a-4426-8e8a-b7e9dd126515',
     'owner': '6',
     'protected': False},
    {'id': 'ab4671e0-50c6-4f12-b8d3-e471db8c1e6e',
     'is_public': False,
     'name': 'gsilantiev-snapshot',
     'owner': '13',
     'protected': False},
    {'id': 'ae8d04e9-95f0-4f81-afaa-db2b9d6a72c0',
     'is_public': False,
     'name': 'test_img',
     'owner': '6',
     'protected': False},
    {'id': 'b3ed64df-50b0-40ac-946c-9351b38ce3c6',
     'is_public': False,
     'name': 'test-img-015b2439-558f-4245-863f-7d71d182a18f',
     'owner': '6',
     'protected': False},
    {'id': 'c17e9725-c8d3-4aba-b6af-aa7db8c76911',
     'is_public': False,
     'name': 'test_img',
     'owner': '6',
     'protected': False},
    {'id': 'ca39b468-df9a-4e40-a2c8-b4eef7b2feda',
     'is_public': False,
     'name': 'test-img-a265e63a-7431-4b29-8463-671fd41e420b',
     'owner': '6',
     'protected': False},
    {'id': 'd31a2785-0f1f-4539-8923-43d68fc55604',
     'is_public': False,
     'name': 'pmo-wiki-snapshot',
     'owner': '11',
     'protected': False},
    {'id': 'de787196-d04d-43d9-ada1-d0e335cd67ed',
     'is_public': False,
     'name': 'stest-snapshot2',
     'owner': '6',
     'protected': False},
    {'id': 'fa855447-7b69-4e47-9e34-7ac116093f60',
     'is_public': False,
     'name': 'test-img-fd23e391-6ee3-4b89-83bf-5dbcf8689ebf',
     'owner': '6',
     'protected': False},
    {'id': 'fe6e36af-8c2b-449b-bba6-5af53b7a6070',
     'is_public': False,
     'name': 'test-img-1ff4cced-0236-4c7f-9385-cfc7e9e19043',
     'owner': '6',
     'protected': False}]
